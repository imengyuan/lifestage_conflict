---
title: "Rumex DE analysis"
author: "Meng"
date: "2023-05-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
directory="/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_haploid_sel/"
library(ggplot2)
library(dplyr)
library("DESeq2")
library("stringr")
library(rattle)
```

## prep dataset
```{r}
readcnt <- read.table(paste0(directory,"/deseq2/readcnts_eqtl_RNA_sept.txt"),header=T)
head(readcnt)
readcnt_matrix<-as.matrix(readcnt[ , -c(1:6)]) #
rownames(readcnt_matrix) <- readcnt[ , 1]
head(readcnt_matrix)
str(readcnt_matrix)
meta_data <- data.frame(colnames(readcnt_matrix))
write.csv(meta_data, file=paste0(directory,"/deseq2/meta_data.csv"), row.names = FALSE)
meta_data<-read.csv(paste0(directory,"/deseq2/meta_data.csv"))

gene <- readcnt[,1]
readcnt <- readcnt[ , -c(1:6)]
# get pollen and male leaf samples
meta_data$id <- seq.int(nrow(meta_data))
l_m <- meta_data %>% filter(sex == "male") %>% select(id)
# l_f <- meta_data %>% filter(sex == "female") %>% select(id)
l_p <- meta_data %>% filter(tissue == "pollen") %>% select(id)

readcnt_m <- readcnt[,c(t(l_p),t(l_m))]
meta_data_m <- meta_data[c(t(l_p),t(l_m)),]
readcnt_matrix<-as.matrix(readcnt_m) 
rownames(readcnt_matrix) <- gene
head(readcnt_matrix)
str(readcnt_matrix)

write.table(readcnt_m, file=paste0(directory,"/deseq2/readcnts_eqtl_RNA_sept_m.txt"))
write.csv(meta_data_m, file=paste0(directory,"/deseq2/meta_data_m.csv"), row.names = FALSE)

```



## run deseq2 (male leaf vs pollen)
```{r}
dds_tissue <- DESeqDataSetFromMatrix(countData = readcnt_matrix, 
                              colData = meta_data_m,
                              design = ~ tissue)
dds_tissue <- DESeq(dds_tissue)
resultsNames(dds_tissue) # "tissue_pollen_vs_leaf"
res_tissue <- results(dds_tissue)
head(res_tissue)
summary(res_tissue)
result_tissue <- res_tissue[complete.cases(res_tissue),]
nrow(res_tissue) # 30641
nrow(result_tissue) # 25050

```


PCA plot
```{r}
vsdata_tissue <- vst(dds_tissue, blind=FALSE)
# pdf("pca_tissue.pdf")
plotPCA(vsdata_tissue, intgroup=c("tissue")) 
```

MA plot
```{r}
plotMA(res_tissue, ylim=c(-2,2))
resLFC <- lfcShrink(dds_tissue, coef="tissue_pollen_vs_leaf", type="apeglm")
plotMA(resLFC, ylim=c(-2,2))
```

## get mean normalized cnts
```{r}
normalized_counts <- as.data.frame(counts(dds_tissue, normalized=T))
normalized_counts <- normalized_counts %>% mutate(gene=rownames(normalized_counts)) 
normalized_counts <- normalized_counts[,c(153,1:152)]
normalized_counts$gene <- str_sub(normalized_counts$gene, end=-4)
write.table(normalized_counts, file = paste0(directory,"normalized_counts_m.txt"), quote = FALSE)

col<-data.frame(colnames(normalized_counts))
normalized_counts<-normalized_counts %>%  mutate(p_mean = rowMeans(normalized_counts[,c(2:76)] )) %>% mutate(l_mean = rowMeans(normalized_counts[,c(77:153)] ))
normalized_counts$mean <- rowMeans(normalized_counts[,c(2:153)])

normalized_counts<- normalized_counts %>% mutate(p_l_ratio = p_mean/l_mean)
cnt<- normalized_counts %>% select(c(1,154:157))

head(cnt)
write.table(cnt, file = paste0(directory,"cnt.txt"), row.names = FALSE)
```

### proportion of pollen expressed genes
```{r}
pollen_expressed <- normalized_counts %>% filter(p_mean>5) # 15958
nrow(pollen_expressed)/nrow(normalized_counts) # 0.5208055

expressed <- normalized_counts %>% filter(p_mean>5 | l_mean>5) #17984
nrow(pollen_expressed)/nrow(expressed) # 0.8873443
```


## get significant DE genes
no baseMean cutoff, relaxed p cutoff
```{r}
# DE_tissue<-as.data.frame(subset(result_tissue, padj<0.05 & abs(log2FoldChange)>1))
# DE_tissue<-as.data.frame(subset(result_tissue, padj<0.1))
DE_tissue<-as.data.frame(result_tissue)
DE_tissue <- DE_tissue %>% mutate(gene = rownames(DE_tissue))
DE_tissue$gene <- str_sub(DE_tissue$gene, end=-4)
DE_tissue <- DE_tissue[,c(7,1:6)]
head(DE_tissue) 

write.table(DE_tissue, file = paste0(directory,"DE_tissue.txt"), row.names = FALSE, quote = FALSE)
# DE_tissue <- read.csv("/Users/yuanmeng/Dropbox/Rumex_eQTL/plot/DE_tissue.csv")

# DE_tissue<-subset(DE_tissue, padj<0.1 & baseMean >= 1) # 18638

DE_tissue <- left_join(DE_tissue,cnt,by="gene")
DE_tissue <- DE_tissue %>% filter(p_mean>5 | l_mean>5)

DE_tissue<-subset(DE_tissue, padj<0.1 & baseMean >= 5) # 16081
write.table(DE_tissue, file = paste0(directory,"DE_tissue_p01_baseMean1.txt"), row.names = FALSE, quote = FALSE) 

DE_tissue_pollen <-  DE_tissue %>% filter(log2FoldChange>0) # 7565 #6231
DE_tissue_leaf <-  DE_tissue %>% filter(log2FoldChange<0) # 11073 #9850
head(DE_tissue_pollen)

# write.csv(DE_tissue_pollen, file = "/Users/yuanmeng/Dropbox/Rumex_eQTL/plot/pollen_biased_p01.csv", row.names = FALSE, quote = FALSE)
# write.csv(DE_tissue_leaf, file = "/Users/yuanmeng/Dropbox/Rumex_eQTL/plot/leaf_biased_p01.csv", row.names = FALSE, quote = FALSE)

DE_tissue$category <- "DE"
```








## get pollen and leaf specific genes

```{r}
write.table(genes,file = paste0(directory,"genes_ratio_deseq2.txt"), row.names = FALSE, quote = F)
#genes <- read.table(paste0(directory,"gene_ratio_deseq2.txt"),header=T)
p_specific <- genes %>% filter(is.infinite(p_l_ratio))
l_specific <- genes %>% filter(p_l_ratio == 0)

# get .bed file
# gff <-read.table(paste0(directory2,"TE_filtered_REF_LA.gff"))
# colnames(gff)<-c("gene","chrom","start","end")
# p_specific <- inner_join(p_specific,gff, by="gene")
# l_specific <- inner_join(l_specific,gff, by="gene")
# 
# p_specific_DE <- p_specific[complete.cases(p_specific),] # 1228
# l_specific_DE <- l_specific[complete.cases(l_specific),] # 157
# 
# p_specific_full <- left_join(p_specific,gff, by="gene")
# l_specific_full <- left_join(l_specific,gff, by="gene")
# 
# write.table(p_specific,file = "/Users/yuanmeng/Dropbox/Rumex_eQTL/deseq2/p_specific_noTE.txt", row.names = FALSE, quote = F)
# write.table(l_specific,file = "/Users/yuanmeng/Dropbox/Rumex_eQTL/deseq2/l_specific_noTE.txt", row.names = FALSE, quote = F)
# 
# write.table(p_specific_DE,file = paste0(directory,"p_specific_noTE_DE.txt"), row.names = FALSE, quote = F)
# write.table(l_specific_DE,file = paste0(directory,"l_specific_noTE_DE.txt"), row.names = FALSE, quote = F)
# p_specific_DE  
# l_specific_DE
# 
# write.table(p_specific_full,file = "/Users/yuanmeng/Dropbox/Rumex_eQTL/deseq2/p_specific_full.txt", row.names = FALSE, quote = F)
# write.table(l_specific_full,file = "/Users/yuanmeng/Dropbox/Rumex_eQTL/deseq2/l_specific_full.txt", row.names = FALSE, quote = F)
# 
# write.table(l_specific_DE[,c(13:15)],file=paste0(directory,"l_specific_noTE_DE.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
# write.table(p_specific_DE[,c(13:15)],file=paste0(directory,"p_specific_noTE_DE.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
```
   DE nonDE 
38742  9212 

> mean(genes$l_mean)
[1] 151.3402
> mean(genes$p_mean)
[1] 642.4631
> median(genes$l_mean)
[1] 0.4724794
> median(genes$p_mean)
[1] 2.171689


```{r}
genes$category <- ifelse(!is.na(genes$category),"DE","nonDE")
table(genes$category)
ggplot(genes, aes(x = log2(p_mean), y = log2(l_mean), color=category)) + geom_point(size=1,alpha=0.4)+theme_bw()+xlim(1,50000)+ylim(1,50000)

```
   DE nonDE 
38742  9212 

```{r}
ggplot(genes, aes(x = mean, y = log2(p_l_ratio),color=genes$category)) + geom_point(size=1,alpha=0.4)+theme_bw()+xlim(1,50000)
```

## expression level for p and l specific genes
boxplot for p specific, l specific, all genes expressed
```{r}
# expressed
p_specific_DE$category <- "p_specific"
l_specific_DE$category <- "l_specific"
specific_DE<-rbind(p_specific_DE,l_specific_DE)
ggplot(specific_DE, aes(category, baseMean)) + geom_boxplot()+ theme_bw()
ggplot(specific_DE, aes(category, baseMean)) + geom_boxplot()+ theme_bw() +ylim(0,5)
```



## expression quantiles and specific genes
```{r}
# histogram of logFC
ggplot(genes, aes(x = log2FoldChange)) + geom_histogram(binwidth=1)+ theme_bw()
genes_c <- genes[complete.cases(genes),]
sort(genes_c$log2FoldChange)[.95*length(genes_c$log2FoldChange)] # 7.100064
sort(genes_c$log2FoldChange)[.05*length(genes_c$log2FoldChange)] # -3.590239
nrow(genes_c[genes_c$log2FoldChange>=7.100064,]) #1938
nrow(genes_c[genes_c$log2FoldChange<=-3.590239,]) # 1937

nrow(genes_c[genes_c$log2FoldChange>=7.092041,]) # 1360
nrow(genes_c[genes_c$log2FoldChange<=-3.95662,]) # 1359
```



```{r}
p_specific <- genes %>% filter(is.infinite(p_l_ratio)) #1944
l_specific <- genes %>% filter(p_l_ratio == 0) # 1282
```

```{r}
# gff <-read.table(paste0(directory,"TE_filtered_REF_LA.gff"))
sort(genes$p_l_ratio)[.95*length(genes$p_l_ratio)] # inf 23.60025
sort(genes$p_l_ratio)[.05*length(genes$p_l_ratio)] # 0.03215439 0.2216441
nrow(genes[is.infinite(genes$p_l_ratio),]) # 6202
nrow(genes[genes$p_l_ratio == 0,]) # 4188
```

```{r}
# l<-read.table("/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_haploid_sel/deseq2/l_specific_noTE.txt",header=T)
nrow(genes[genes$p_l_ratio <= 0.06246162,]) #3012
nrow(genes[genes$p_l_ratio >= 511.4639,]) #3015

nrow(genes[genes$p_l_ratio <= 0.01685691,]) #1506
```


## use only DE genes forward
quantiles of expression ratio + DE genes
see how many, send a table, prep DFE scripts
```{r}
genes <- genes[complete.cases(genes),] # 27189 -> 16081

# sort(genes$p_l_ratio)[.90*length(genes$p_l_ratio)] # 151.3145
# sort(genes$p_l_ratio)[.10*length(genes$p_l_ratio)] # 0.09127343
# nrow(genes[genes$p_l_ratio <= 0.09127343,]) #2718
# nrow(genes[genes$p_l_ratio >= 151.3145,]) #2720
# 
# sort(genes$p_l_ratio)[.95*length(genes$p_l_ratio)] # 94811.01
# sort(genes$p_l_ratio)[.05*length(genes$p_l_ratio)] # 0.05019033
# nrow(genes[genes$p_l_ratio <= 0.05019033,]) #1359
# nrow(genes[genes$p_l_ratio >= 94811.01,]) #1361
# 
# nrow(genes[genes$p_l_ratio < 0.05019033,]) #1359
# nrow(genes[genes$p_l_ratio > 94811.01,]) #1361
# 
# quantile(genes$p_l_ratio, probs = c(0.05, 0.95)) # 5.020561e-02 9.612066e+04
# nrow(genes[genes$p_l_ratio <= 5.020561e-02,]) #1360
# nrow(genes[genes$p_l_ratio >= 9.612066e+04,]) #1360
# 
# genesl<-genes[genes$p_l_ratio <= 5.020561e-02,]
# genesp<-genes[genes$p_l_ratio >= 9.612066e+04,]
# summary(genesp$log2FoldChange)
# summary(genesl$log2FoldChange)

quantile(genes$p_l_ratio, probs = c(0.1, 0.9)) # 0.08341861 55.39511315
nrow(genes[genes$p_l_ratio <= 0.08341861,]) #2719 -> 1608
nrow(genes[genes$p_l_ratio >= 55.39511315,]) #2719 -> 1608
# extract to check the FC
gff <- read.table(paste0(directory,"/deseq2/REF_LA_filtered_annotation.genes.gff"))
colnames(gff) <- c("gene","chrom", "start", "end")
genes <- left_join(genes, gff, by="gene")


genesl <- genes[genes$p_l_ratio <= 0.08341861,] 
genesp <- genes[genes$p_l_ratio >= 55.39511315,] 

genesl <- genesl[genesl$log2FoldChange <= -2,]
genesp <- genesp[genesp$log2FoldChange >= 2,]

nrow(genesl[genesl$log2FoldChange <= -2,]) 
nrow(genesp[genesp$log2FoldChange >= 2,]) 
   


unbiased<-genes[genes$p_l_ratio>0.95 & genes$p_l_ratio<1.05,]
```
summary(genesp$log2FoldChange)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 -7.380  -5.046  -4.614  -3.941  -4.226   1.593 
summary(genesl$log2FoldChange)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  2.242   2.489   3.319   5.789   6.691  28.471
  
pollen specific genes should be pollen biased, logFC should>0
leaf specific genes should be leaf biased, logFC should <0
l mean >p mean but logFC >0 (FC >1), damn....
  
     Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.546   3.189   6.971   7.208   9.396  28.471 
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 -7.380  -4.614  -3.949  -3.677  -3.496   2.220
  
  ggplot(specific_DE, aes(category, baseMean)) + geom_boxplot()+ theme_bw() +ylim(0,5)
```{r}
genesl$category <- "leaf-specific"
genesp$category <- "pollen-specific"
genes_specific <- rbind(genesl,genesp)
genes_specific <- rbind(genesl_final1,genesp_final1)
ggplot(genes_specific, aes(category, mean))+ geom_boxplot()+ theme_bw() + ylim(0,500)

genesl$mean <- genesl$l_mean
genesp$mean <- genesp$p_mean

```
  
```{r}
ggplot(genes_specific, aes(category, baseMean))+  theme_bw()+geom_violin(trim=FALSE)+geom_boxplot(width=0.05)+ylim(0,50)+ylab("expression level (baseMean)")
ggplot(genes_specific, aes(category, baseMean))+  theme_bw()+geom_violin(trim=FALSE)+geom_boxplot(width=0.05)+ylab("expression level (baseMean)")
#ggplot(genes_specific, aes(category, baseMean))+  theme_bw()+geom_violin(trim=FALSE)+geom_boxplot(width=0.05)

#ggplot(genes_specific, aes(category, mean))+  theme_bw()+geom_violin(trim=FALSE)+geom_boxplot(width=0.05)

ggplot(genes_specific, aes(category, mean))+  theme_bw()+geom_violin(trim=FALSE)+geom_boxplot(width=0.05)+ylim(0,6)+ylab("expression level (baseMean)")

ggplot(genes_specific, aes(x=baseMean,fill=category))+  theme_bw()+geom_histogram(alpha=0.5,position="identity")+ylab("expression level (baseMean)")+xlim(0,1000)

#+ylim(0,250)
```

remove outlier
```{r}
outliersl <- boxplot(genesl$baseMean, plot=FALSE)$out
l<-genesl
l<- l[-which(l$baseMean %in% outliersl),]

outliersp <- boxplot(genesp$baseMean, plot=FALSE)$out
p<-genesp
p<- p[-which(p$baseMean %in% outliersp),]
genes_specific2 <-rbind(l,p)

ggplot(genes_specific2, aes(category, baseMean))+  theme_bw()+geom_violin(trim=FALSE)+geom_boxplot(width=0.05)

```



save .bed file for DFE
use both mean and baseMean as cutoff
adding low end cutoff, maybe FC will be normal
```{r}
genesl_final1 <- genesl %>% filter(mean>=5) #
#genesl_final2 <- genesl %>% filter(mean<=20)

genesp_final1 <- genesp %>% filter(mean>=5)

directory="/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_haploid_sel/deseq2/"
write.table(genesl_final1[,c(13:15)],file=paste0(directory,"l_specific_final1.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(genesp_final1[,c(13:15)],file=paste0(directory,"p_specific_final1.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)

```

genesl_final1 2287
genesp_final1 1627 (pollen has more lowly expressed ones)
p 698 150 151 628
l 606 405 503 773

binning based on expression level (baseMean?)


```{r}
# genes<-left_join(cnt,DE_tissue,by="gene")
# write.table(cnt, file = "/Users/yuanmeng/Dropbox/Rumex_eQTL/deseq2/cnt.txt", row.names = FALSE, quote = F)
# genes1 <- genes %>% filter(l_mean >=5 & p_mean>=5)
#genes1 <- genes %>% filter(mean >=5)
bin<-binning(genes$baseMean, bins=4, method="quantile",
                     labels=NULL, ordered=TRUE, weights=NULL)


plot(bin)

p_qt1 <- genesp %>% filter(baseMean <= 27)
p_qt2 <- genesp %>% filter(baseMean > 27 & baseMean <= 83.8)
p_qt3 <- genesp %>% filter(baseMean > 83.8 & baseMean <= 246)
p_qt4 <- genesp %>% filter(baseMean > 246)

l_qt1 <- genesl %>% filter(baseMean <= 27)
l_qt2 <- genesl %>% filter(baseMean > 27 & baseMean <= 83.8)
l_qt3 <- genesl %>% filter(baseMean > 83.8 & baseMean <= 246)
l_qt4 <- genesl %>% filter(baseMean > 246)


write.table(p_qt1[,13:15],file=paste0(directory,"DFE/p_qt1.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(p_qt2[,13:15],file=paste0(directory,"DFE/p_qt2.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(p_qt3[,13:15],file=paste0(directory,"DFE/p_qt3.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(p_qt4[,13:15],file=paste0(directory,"DFE/p_qt4.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(l_qt1[,13:15],file=paste0(directory,"DFE/l_qt1.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(l_qt2[,13:15],file=paste0(directory,"DFE/l_qt2.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(l_qt3[,13:15],file=paste0(directory,"DFE/l_qt3.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
write.table(l_qt4[,13:15],file=paste0(directory,"DFE/l_qt4.bed"),sep="\t",row.names = FALSE, col.names = FALSE, quote=FALSE)
```
5.27]
(27, 83.8]
(83.8, 246]
(246, 

2.5]
(2.5,33.1]
(33.1,157]
(157
genes 27189
genes1 15323
 

