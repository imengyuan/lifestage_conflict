---
title: "pi_n and pi_s"
author: "Meng"
date: "2023-11-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```


# pi_n / pi_s and expression in ceratodon

```{r}
directory="/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/ceratodon_haploid_sel/diversity/"
ratio_pixy <- read.csv(paste0(directory,"ratio_pixy_innerjoin.txt"))
pixy <- read.table(paste0(directory,"auto_nonsyn_geneWise_pi.txt"), header=TRUE) 
pixy <- pixy[complete.cases(pixy),] # 32725
pixy <- pixy %>% filter(no_sites >= 50) #32349
head(pixy)
colnames(pixy)[2:5] <- c("chrom", "start", "end","avg_pi_nonsyn")

ratio_pixy <- inner_join(ratio_pixy, pixy, by=c("pop", "chrom", "start", "end")) #  (18615 no UV)
write.csv(ratio_pixy, file = paste0(directory,"ceratodon_pi_n_pi_s.csv"), row.names = FALSE, quote = FALSE)
stats  <- read.csv(paste0(directory,"ceratodon_pi_n_pi_s.csv"))

geness_a <- geness_a %>% dplyr::select(1)
genesg_a <- genesg_a %>% dplyr::select(1)
unbiased <- unbiased %>% dplyr::select(1)
stats_genesg_a <- inner_join(genesg_a, stats, by="gene") # 1091 1217
stats_geness_a <- inner_join(geness_a, stats, by="gene") # 1049 1232
stats_unbiased <- inner_join(unbiased, stats, by="gene") # 3715 4319

write.table(stats_genesg_a, file = paste0(directory,"stats_genesg_a.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
write.table(stats_geness_a, file = paste0(directory,"stats_geness_a.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
write.table(stats_unbiased, file = paste0(directory,"stats_unbiased.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
```


```{r}
calculate_pi <- function(data) {
  data <- data %>%
    mutate(pi_syn = avg_pi * no_sites.x) %>%
    mutate(pi_nonsyn = avg_pi_nonsyn * no_sites.y)
  
  sum_pi_syn <- sum(data$pi_syn)
  sum_pi_nonsyn <- sum(data$pi_nonsyn)
  sum_no_sites_x <- sum(data$no_sites.x)
  sum_no_sites_y <- sum(data$no_sites.y)
  
  weighted_pi_syn <- sum_pi_syn / sum_no_sites_x
  weighted_pi_nonsyn <- sum_pi_nonsyn / sum_no_sites_y
  
  mean_avg_pi <- mean(data$avg_pi)
  mean_avg_pi_nonsyn <- mean(data$avg_pi_nonsyn)
  
  result <- data.frame(
    sum_pi_syn = sum_pi_syn,
    sum_pi_nonsyn = sum_pi_nonsyn,
    sum_no_sites_x = sum_no_sites_x,
    sum_no_sites_y = sum_no_sites_y,
    mean_avg_pi = mean_avg_pi,
    mean_avg_pi_nonsyn = mean_avg_pi_nonsyn,
    weighted_pi_syn = weighted_pi_syn,
    weighted_pi_nonsyn = weighted_pi_nonsyn,
    ratio_weighted_pis = weighted_pi_nonsyn / weighted_pi_syn
  )
  
  return(result)
}

pi_genesg_a <- calculate_pi(stats_genesg_a)
pi_genesg_a$category <- "genesg_a" 
    
pi_geness_a <- calculate_pi(stats_geness_a)
pi_geness_a$category <- "geness_a" 

pi_unbiased <- calculate_pi(stats_unbiased)
pi_unbiased$category <- "unbiased" 

pi_c <- rbind(pi_genesg_a, pi_geness_a, pi_unbiased)
write.table(pi_c, file = paste0(directory,"weighted_pi_c.txt"), row.names = FALSE, sep = "\t", quote = FALSE)

```




# pi_n / pi_s and expression in rumex

## read files
```{r}
directory="/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_haploid_sel/deseq2/"
genesl <- read.table(paste0(directory,"genesl.txt"))
genesp <- read.table(paste0(directory,"genesp.txt"))

directory="/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_haploid_sel/pixy/"
FC_pixy <- read.table(paste0(directory,"FC_pixy_innerjoin.txt"),header = TRUE) #11734
pixy_nonsyn <- read.table(paste0(directory,"pixy_pi_nonsyn.0329.genewise.txt"), header=TRUE) #27026
colnames(pixy_nonsyn)[2:5] <- c("chrom", "start", "end", "avg_pi_nonsyn")
pixy_nonsyn <- pixy_nonsyn %>% filter(no_sites>=50) # 22186

statsr <- inner_join(FC_pixy, pixy_nonsyn, by=c("pop", "chrom", "start", "end")) # 11734
write.csv(statsr, file = paste0(directory,"rumex_pi_n_pi_s.csv"), row.names = FALSE, quote = FALSE)
statsr <- read.csv(paste0(directory,"rumex_pi_n_pi_s.csv"))

genesl <- genesl %>% dplyr::select(1)
genesp <- genesp %>% dplyr::select(1)
unbias <- unbias %>% dplyr::select(1)
statsr_genesl <- inner_join(genesl, statsr, by="gene") # 1076 1149
statsr_genesp <- inner_join(genesp, statsr, by="gene") # 869 920
statsr_unbiased <- inner_join(unbias, statsr, by="gene") # 500 532

write.table(statsr_genesl, file = paste0(directory,"statsr_genesl.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
write.table(statsr_genesp, file = paste0(directory,"statsr_genesp.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
write.table(statsr_unbiased, file = paste0(directory,"statsr_unbiased.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
```


## calculate weighted average of pi_n and pi_s

```{r}
pi_genesp <- calculate_pi(statsr_genesp)
pi_genesp$category <- "genesp" 
    
pi_genesl <- calculate_pi(statsr_genesl)
pi_genesl$category <- "genesl" 

pi_unbiased <- calculate_pi(statsr_unbiased)
pi_unbiased$category <- "unbiased" 

pi_r <- rbind(pi_genesp, pi_genesl, pi_unbiased)
write.table(pi_r, file = paste0(directory,"weighted_pi_r.txt"), row.names = FALSE, sep = "\t", quote = FALSE)
```



## count SNPs
```{r}
snp <- read.table("/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/ceratodon_haploid_sel/diversity/SNP_conuts.txt", header = T)
rumex <- snp[1:2,]
rownames(rumex) <- rumex[,2]
rumex <- rumex[,3:4]
fisher.test(rumex)

ceratodon <- snp[3:4,]
rownames(ceratodon) <- ceratodon[,2]
ceratodon <- ceratodon[,3:4]
fisher.test(ceratodon)

```
data:  rumex
p-value = 3.795e-13
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
 0.8518378 0.9121155
sample estimates:
odds ratio 
 0.8814661 
 
data:  ceratodon
p-value = 0.2117
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
 0.949515 1.011663
sample estimates:
odds ratio 
 0.9800688

```{r}
rumex_cnt <- read.table("/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/ceratodon_haploid_sel/diversity/SNP_conuts2.txt", header = T)
hcols <- c("black",  "white")
ggplot(rumex_cnt) +
geom_col(aes(x = lifestage, y = count, fill = category), colour ="black")  + xlab("") + ylab("") + theme_light() + scale_fill_manual(values = hcols) + theme(axis.text=element_text(size=18), axis.title=element_text(size=18)) + guides(fill = guide_legend(override.aes = list(size = 12)))

ggplot(rumex_cnt) +geom_col(aes(x = lifestage, y = count, fill = category),position = "fill", colour ="black")  + xlab("") + ylab("") + theme_light() + scale_fill_manual(values = hcols) + theme(axis.text=element_text(size=18), axis.title=element_text(size=18)) + guides(fill = guide_legend(override.aes = list(size = 12)))

```

